#!/usr/bin/env python
'''
\x1b[1mUsage:\x1b[0m
    {0} <bat-test> <output> <destination> [<path0> <path1> ...]

\x1b[1mInformation:\x1b[0m
    Prints B.A.T.M.A.N convergence in gnuplot format.
    - The bat-test file is supposed to be the output of a batman session;
    - The output file will contain the input for gnuplot;

\x1b[1mNote:\x1b[0m
    The program writes on stdout the plotting request for gnuplot. Try to
    launch like this:
        {0} <params> | gnuplot -persist

'''

from itertools import izip as zip, \
                      count
import sys
import batparser
import utils

def analyze (status, outfn, destination, *paths):
    out = utils.safe_open(outfn)
    while (status.step()):
        entry = status.get_entry(destination)
        for p in paths:
            out.write(' %d' % entry.quality_of(p))
        out.write('\n')
    out.close()
    return paths

def main (argv=None):
    if not argv: argv = sys.argv

    params = iter(argv)
    progname = next(params)
    if len(argv) < 4:
        sys.stderr.write(__doc__.format(progname))
        return 1

    ifile = open(next(params))
    outfn = next(params)
    try:
        paths = analyze(batparser.Status(ifile), outfn, next(params),
                        *params)
    except IOError, msg:
        print >>sys.stderr, str(msg)
        return 1

    ifile.close()

    utils.suggest(sys.stdout, outfn, None, *zip(paths, count(1)))

    return 0

if __name__ == '__main__':
    sys.exit(main())

